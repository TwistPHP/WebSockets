/**
 * Twist WebSockets 5.0.0 | Andrew Hosgood - 13/05/2014
 */
(function(e,t){try{var n=function(e){return e.replace(/[\s\t\r\n]*/g,"")==""},r=function(e){return parseFloat(e)==parseInt(e)&&!isNaN(e)},i=function(e){return typeof e==="null"||e===null},s=function(e){return e!==null&&e!==undefined&&typeof e!=="null"&&typeof e!=="undefined"&&e!=="undefined"},o=function(e,t){e=s(e)&&r(e)?e:16;var n="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",i="";if(typeof t==="string"){n=t}else if(t===true){n+="!@Â£$%^&*()_-=+[]{};:|<>?/"}for(var o=0;o<e;o++){var u=Math.floor(Math.random()*n.length);i+=n.substring(u,u+1)}return i},u=function(r,u,a){var f=this;f.log=function(){if(f.objOptions.debug&&arguments.length&&e.console&&e.console.log){for(var t in arguments){console.log(arguments[t])}}},f.port=1085,f.status=0;if(n(r)){f.log("WebSocket location not defined");return false}else{f.socketDomain=r}var l={};if(typeof u==="number"||typeof u==="string"&&u!==""&&!isNaN(u)){f.port=u;if(typeof a==="object"){l=a}}else{if(typeof u==="object"){l=u}}f.objOptions={actions:{},activitytimeout:1e4,autoreconnects:5,autoreconnectonclose:true,autoreconnectonerror:false,autoreconnectonoffline:true,autoreconnecttime:1e3,credentials:{uid:"guest"},debug:false,onchangestatus:function(){},onclose:function(){},onconnect:function(){},ondebug:function(){},onerror:function(){},onlogin:function(){},onfirstlogin:function(){},onmessage:function(){},onoffline:function(){},ononline:function(){},onrestart:function(){},protocol:"echo-protocol",queuemessages:true,quiet:true,shareactivity:false},f.arrQueuedMessages=[],f.blUserActive=false,f.connect=function(){f.status=4;f.reconnects++;if(f.reconnects<f.objOptions.autoreconnects){try{if(typeof MozWebSocket!="undefined"){f.webSocket=new MozWebSocket(f.strSocketUrl,f.objOptions.protocol);f.log("Opening:   "+f.strSocketUrl+" (Mozilla WebSocket)")}else if(e.WebSocket){f.webSocket=new WebSocket(f.strSocketUrl,f.objOptions.protocol);f.log("Opening:   "+f.strSocketUrl)}else{if(!f.objOptions.quiet){alert("WebSockets are not supported on this browser")}f.log("WebSockets are not supported on this browser");f.status=0;return false}}catch(n){f.log(n)}f.webSocket.onopen=function(){f.status=this.readyState;f.log("Status:    Connected");f.objOptions.autoreconnecttime=f.intAutoreconnectTime;try{f.objOptions.onchangestatus(f.webSocket.readyState);f.objOptions.onconnect();f.login()}catch(e){f.log(e)}},f.webSocket.onmessage=function(n){f.status=this.readyState;try{var r=f.jsonDecode(n.data);if(r.system==="twist"){switch(r.action){case"clientDetails":f.send("twist","clientDetails",{screen:{width:screen.width,height:screen.height},window:{width:$(e).width(),height:$(e).height()},document:{width:$(t).width(),height:$(t).height()}});break;case"debug":f.log("Twist:     "+n.data);f.objOptions.ondebug(r);break;case"echo":f.send("twist","echo",r);break;case"error":f.log("Error:     "+n.data);break;case"login":f.log("===============\nTWISTPHP\nWebsocket Server\n===============\n"+r.message);while(f.arrQueuedMessages.length){var i=f.arrQueuedMessages[0];f.send(i.system,i.action,i.data);f.arrQueuedMessages.shift()}f.reconnects=0;f.objOptions.onfirstlogin();f.objOptions.onfirstlogin=function(){};f.objOptions.onlogin();break;case"promptLogin":f.login();break;case"restart":f.log("Restart:   "+r.data.time+" seconds");f.objOptions.onrestart(r);f.intAutoreconnectTime=f.objOptions.autoreconnecttime;f.objOptions.autoreconnecttime=(r.data.time+2)*1e3;break;default:f.log("Unknown:   "+n.data);break}}else if(r.system==="debug"){switch(r.action){case"echo":case"echoEveryone":var o=r.action==="echoEveryone"?"Echo:      ":"Echo All:  ";if(f.objEchos[r.instance]){var u=(new Date).getTime()-f.objEchos[r.instance];f.log(o+u+"ms");delete f.objEchos[r.instance]}else{f.log(o+r.instance)}f.objOptions.onmessage(r);break;case"echoEveryoneElse":f.log("Echo EE:    "+r.instance);f.objOptions.onmessage(r);break;default:f.log("Debug:     "+n.data);f.objOptions.ondebug(r);break}}else{f.log("Received:  "+n.data);f.objOptions.onmessage(r);if(s(f.objCallbacks[r.instance])){var a=f.objCallbacks[r.instance];a(r);delete f.objCallbacks[r.instance]}if(s(f.objOptions.actions[r.system])&&typeof f.objOptions.actions[r.system][r.action]==="function"){f.objOptions.actions[r.system][r.action](r)}}}catch(l){f.log(l)}},f.webSocket.onerror=function(e){f.status=this.readyState;f.log("Error:",e);try{f.objOptions.onchangestatus(f.webSocket.readyState);f.objOptions.onerror(e);if(f.objOptions.autoreconnectonerror&&(f.status===0||f.status===2||f.status===3)){clearTimeout(f.funReconnectTimeout);f.funReconnectTimeout=setTimeout(function(){f.log("Status:    Reconnecting...("+(f.reconnects+1)+" of "+f.objOptions.autoreconnects+")");f.connect()},f.objOptions.autoreconnecttime)}}catch(t){f.log(t)}},f.webSocket.onclose=function(e){f.status=this.readyState;f.log("Status:    Connection closed");try{f.objOptions.onchangestatus(f.webSocket.readyState);f.objOptions.onclose(e);if(f.objOptions.autoreconnectonclose&&(f.status===0||f.status===2||f.status===3)){clearTimeout(f.funReconnectTimeout);f.funReconnectTimeout=setTimeout(function(){f.log("Status:    Reconnecting...("+(f.reconnects+1)+" of "+f.objOptions.autoreconnects+")");f.connect()},f.objOptions.autoreconnecttime)}}catch(t){f.log(t)}};return true}},f.funActivityWatcher,f.funReconnectTimeout,f.getStatus=function(){var e={0:"Not Connected",1:"Connected",2:"Connection Lost",3:"Closed",4:"Connecting..."};return e[f.status]},f.jsonDecode=function(e){if(JSON){try{return JSON.parse(e)}catch(t){return{failed:t}}}else{return $.parseJSON(e)}},f.jsonEncode=function(e){return JSON.stringify(e)},f.kill=function(){var e=f.objOptions.autoreconnectonclose;f.objOptions.autoreconnectonclose=false;f.objOptions.autoreconnectonerror=false;f.log(f.getStatus());clearTimeout(f.funReconnectTimeout);clearTimeout(f.funActivityWatcher);f.webSocket.close();f.log(f.getStatus());f.objOptions.autoreconnectonclose=e},f.login=function(){f.log("Log in:    "+f.jsonEncode(f.objOptions.credentials));f.send("twist","login",f.objOptions.credentials)},f.logout=function(){f.send("twist","logout")},f.objCallbacks={},f.objEchos={},f.reconnects=0,f.send=function(e,t,n,r){var i=(new Date).getTime(),s=i+o(32),u={},a=function(){};if(e==="debug"&&(t==="echo"||t==="echoEveryone")){f.objEchos[s]=i}if(typeof n==="object"||typeof n==="string"||typeof n==="number"||typeof n==="array"){u=n;if(typeof r==="function"){a=r}}else if(typeof n==="function"){a=n}var l={system:e,action:t,data:u,instance:s},c=f.jsonEncode(l);if(f.status===1){f.log("Sending:   "+c);try{f.webSocket.send(c);f.objCallbacks[s]=a}catch(h){if(f.objOptions.queuemessages){f.log("Queued:    "+c);f.arrQueuedMessages.push(l)}else{f.log("Failed:    "+c)}f.log(h);f.objOptions.onerror();return false}}else{if(f.objOptions.queuemessages){f.log("Queued:    "+c);f.arrQueuedMessages.push(l)}else{f.log("Failed:    "+c)}if(f.status!==4){f.connect();return false}}return s},f.strSocketUrl=(e.location.protocol==="https:"?"wss":"ws")+"://"+f.socketDomain+":"+f.port,f.webSocket;var c={onblur:i(e.onblur)?function(){}:e.onblur,onfocus:i(e.onfocus)?function(){}:e.onfocus,onkeypress:i(e.onkeypress)?function(){}:e.onkeypress,onload:i(e.onload)?function(){}:e.onload,onmousemove:i(e.onmousemove)?function(){}:e.onmousemove,ononline:i(e.ononline)?function(){}:e.ononline,onoffline:i(e.onoffline)?function(){}:e.onoffline,onpopstate:i(e.onpopstate)?function(){}:e.onpopstate};e.ononline=function(e){c.ononline(e);f.objOptions.ononline();if(f.objOptions.debug){f.log("Browser came online")}if(f.objOptions.autoreconnectonoffline&&(f.status===0||f.status===2||f.status===3)&&f.reconnects<f.objOptions.autoreconnects){try{f.connect()}catch(t){f.log(t)}}},e.onoffline=function(e){c.onoffline(e);f.objOptions.onoffline();if(f.objOptions.debug){f.log("Browser went offline")}f.webSocket.close();f.webSocket=null};for(var h in l){f.objOptions[h]=l[h]}f.intAutoreconnectTime=f.objOptions.autoreconnecttime;if(f.objOptions.shareactivity){var p=function(){if(!f.blUserActive){f.send("twist","active");f.send("twist","uri",e.location.href);f.blUserActive=true}clearTimeout(f.funActivityWatcher);f.funActivityWatcher=setTimeout(function(){f.send("twist","inactive");f.send("twist","uri",e.location.href);f.blUserActive=false},f.objOptions.activitytimeout)};e.onload=function(e){c.onload(e);p.call()},e.onmousemove=function(e){c.onmousemove(e);p.call()},e.onkeypress=function(e){c.onkeypress(e);p.call()},e.onpopstate=function(t){c.onpopstate(t);f.send("twist","uri",e.location.href)},e.onfocus=function(e){c.onfocus(e);f.send("twist","focus")},e.onblur=function(e){c.onblur(e);f.send("twist","blur")}}return f.connect()?f:false};e.TwistWebSocket=function(e,t,n){return new u(e,t,n)}}catch(a){if(e.console&&e.console.log){console.log(a)}}})(window,document)